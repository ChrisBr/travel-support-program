= content_for :page_header, t('.title', :default => [:'helpers.titles.edit', 'Edit %{model}'], :model => Reimbursement.model_name.human)

%strong.label= Reimbursement.human_attribute_name(:event)
%br
= render resource.event

%strong.label= Reimbursement.human_attribute_name(:request)
%br
= render parent

%strong.label= t(:general_info)
%br
= simple_form_for resource, :url => request_reimbursement_path(parent), :method => :put do |f|
  .form-inputs.form-horizontal
    = f.input :description, :input_html => {:rows => 3}

  .form-inputs.form-inline
    %strong.label= Request.human_attribute_name(:attachments)
    - if !resource.errors[:attachments].empty?
      .alert.alert-inline.alert-error= resource.attachments.map {|e| e.errors.full_messages}.uniq.join("; ")
    %table.table.table-condensed
      %thead
        %tr
          %th= ReimbursementAttachment.human_attribute_name(:title)
          %th= ReimbursementAttachment.human_attribute_name(:file)
          %th
      %tbody#attachments
        = f.simple_fields_for :attachments do |attachment|
          = render 'attachment_fields', :f => attachment
        %tr#attachments_links
          %td= link_to_add_association t(:add_attachment), f, :attachments, "data-association-insertion-node" => "#attachments_links"

  .form-inputs.form-inline
    %strong.label= Reimbursement.human_attribute_name(:expenses)
    - if !resource.errors[:"request.expenses"].empty?
      .alert.alert-inline.alert-error= resource.expenses.map {|e| e.errors.full_messages}.uniq.join("; ")
    %table.table.table-condensed
      %thead
        %tr
          %th= Reimbursement.human_attribute_name(:subject)
          %th= Reimbursement.human_attribute_name(:description)
          %th= Reimbursement.human_attribute_name(:estimated_amount)
          %th= Reimbursement.human_attribute_name(:approved_amount)
          %th= Reimbursement.human_attribute_name(:total_amount)
          %th= RequestExpense.human_attribute_name(:authorized_amount)
      %tbody#expenses
        = f.simple_fields_for :request do |request|
          = request.simple_fields_for :expenses do |e|
            - expense = e.object
            %tr
              %td= expense.subject
              %td= expense.description
              %td= number_to_currency(expense.estimated_amount, :unit => expense.estimated_currency)
              %td= number_to_currency(expense.approved_amount, :unit => expense.approved_currency)
              - if can? :submit, resource
                %td= number_to_currency(e.text_field(:total_amount, :class => 'input-mini'), :unit => expense.approved_currency)
                %td= number_to_currency(expense.authorized_amount, :unit => expense.authorized_currency)
              - elsif can? :approve, resource
                %td= number_to_currency(expense.total_amount, :unit => expense.total_currency)
                %td= number_to_currency(e.text_field(:authorized_amount, :class => 'input-mini'), :unit => expense.authorized_currency)
              - else
                %td= number_to_currency(expense.total_amount, :unit => expense.total_currency)
                %td= number_to_currency(expense.authorized_amount, :unit => expense.authorized_currency)

  .form-actions
    = f.button :submit, :class => 'btn-primary'
    = link_to t('.cancel', :default => t("helpers.links.cancel")), reimbursements_path, :class => 'btn'
